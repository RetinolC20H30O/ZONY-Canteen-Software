<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horwang Canteen - ระบบร้านค้า</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>window.react = window.React; window.reactDOM = window.ReactDOM;</script>
    <script src="https://unpkg.com/lucide-react@0.292.0/dist/umd/lucide-react.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Kanit', sans-serif
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        @keyframes pulse-dot {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .4
            }
        }

        .fade-in {
            animation: fadeIn .4s ease-out forwards
        }

        .slide-up {
            animation: slideUp .5s ease-out forwards
        }

        .pulse-dot {
            animation: pulse-dot 1.5s ease-in-out infinite
        }

        .glass {
            background: rgba(255, 255, 255, .08);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, .15)
        }

        .stat-card {
            transition: all .3s
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .1)
        }
    </style>
</head>

<body class="bg-gray-100">
    <div id="root"></div>
    <div id="error-display"
        style="display:none; position:fixed; bottom:0; left:0; right:0; background:#fee2e2; color:#b91c1c; padding:1rem; font-family:sans-serif; font-size:12px; z-index:9999; border-top:1px solid #fecaca;">
        <strong>Error:</strong> <span id="error-message"></span>
    </div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const I = typeof LucideReact !== 'undefined' ? LucideReact : {};
        const icon = name => I[name] || (p => <span style={{ display: 'inline-block', width: 20, height: 20, background: '#ccc', borderRadius: 4, textAlign: 'center', lineHeight: '20px', fontSize: 10 }}>?</span>);
        const [Store, Hash, ChevronRight, Bell, LogOut, Home, ClipboardList, Utensils, BarChart3, DollarSign, ShoppingBag, Clock, AlertCircle, ChefHat, XCircle, CheckCircle, Package, TrendingUp, Plus, X, Save, Eye, EyeOff, Edit3, Trash2] = ['Store', 'Hash', 'ChevronRight', 'Bell', 'LogOut', 'Home', 'ClipboardList', 'Utensils', 'BarChart3', 'DollarSign', 'ShoppingBag', 'Clock', 'AlertCircle', 'ChefHat', 'XCircle', 'CheckCircle', 'Package', 'TrendingUp', 'Plus', 'X', 'Save', 'Eye', 'EyeOff', 'Edit3', 'Trash2'].map(icon);

        const SHOPS_DATA = [
            { id: 1, name: 'ร้านน้ำสวัสดิการ', category: 'drink', menu: [{ name: 'น้ำเปล่า', price: 7 }, { name: 'น้ำแร่มินเนเร่', price: 10 }] },
            { id: 2, name: 'มาลี ก๋วยเตี๋ยวไก่', category: 'noodle', menu: [{ name: 'ก๋วยเตี๋ยวไก่เส้นบะหมี่', price: 40 }, { name: 'เส้นเล็กไก่ฉีก', price: 40 }] },
            { id: 3, name: 'ก๋วยเตี๋ยวต้มยำ', category: 'noodle', menu: [{ name: 'เส้นเล็กต้มยำ', price: 40 }, { name: 'บะหมี่ต้มยำทะเล', price: 50 }] },
            { id: 4, name: 'พระข้าวราดแกง', category: 'rice', menu: [{ name: 'ข้าวราดแกง 2 อย่าง', price: 35 }, { name: 'ข้าวพะแนงหมู', price: 40 }] },
            { id: 5, name: 'ข้าวราดแกง', category: 'rice', menu: [{ name: 'ข้าวแกงเขียวหวาน', price: 35 }, { name: 'ข้าวไข่พะโล้', price: 35 }] },
            { id: 6, name: 'พรผลไม้', category: 'fruit', menu: [{ name: 'แตงโม', price: 20 }, { name: 'สัปปะรด', price: 20 }, { name: 'มะม่วง', price: 25 }] },
            { id: 7, name: 'สุกี้ - ราดหน้า', category: 'rice', menu: [{ name: 'สุกี้น้ำรวมมิตร', price: 45 }, { name: 'ราดหน้าหมูหมัก', price: 40 }] },
            { id: 8, name: 'นันทวรรณก๋วยเตี๋ยวเรือ', category: 'noodle', menu: [{ name: 'ก๋วยเตี๋ยวเรือหมู', price: 40 }, { name: 'ก๋วยเตี๋ยวเรือเนื้อ', price: 50 }, { name: 'เกาเหลาหมู', price: 50 }] },
            { id: 9, name: 'โฉมยง ขนมหวาน', category: 'snack', menu: [{ name: 'น้ำแข็งไส', price: 20 }, { name: 'ลอดช่องน้ำกะทิ', price: 25 }] },
            { id: 10, name: 'อารีนัน ก๋วยเตี๋ยวต้มยำ', category: 'noodle', menu: [{ name: 'ต้มยำน้ำข้น', price: 45 }, { name: 'ต้มยำน้ำใส', price: 40 }] },
            { id: 11, name: 'ก๋วยเตี๋ยวหมูละมุน', category: 'noodle', menu: [{ name: 'ก๋วยเตี๋ยวหมูต้มยำ', price: 40 }] },
            { id: 12, name: 'ข้าวมันไก่ป้าติ๋ม', category: 'rice', menu: [{ name: 'ข้าวมันไก่ต้ม', price: 40 }, { name: 'ข้าวมันไก่ทอด', price: 45 }] },
            { id: 13, name: 'ชุติมา อาหารตามสั่ง', category: 'rice', menu: [{ name: 'ข้าวกะเพราหมูสับ', price: 40 }] },
            { id: 14, name: 'ฐิตืพงศ์ ก๋วยจั๊บ', category: 'noodle', menu: [{ name: 'ก๋วยจั๊บน้ำข้น', price: 40 }] },
            { id: 15, name: 'ป้าอัจ ก๋วยเตี๋ยวหมูเด้ง', category: 'noodle', menu: [{ name: 'เส้นเล็กหมูเด้ง', price: 40 }, { name: 'บะหมี่หมูแดง หมูกรอบ', price: 45 }] },
            { id: 16, name: 'จุ้บแจง อาหารตามสั่ง', category: 'rice', menu: [{ name: 'ข้าวผัดต้มยำแห้ง', price: 45 }] },
            { id: 17, name: 'หอยทอดฮ่องกง', category: 'rice', menu: [{ name: 'หอยทอด', price: 50 }, { name: 'ออส่วน', price: 60 }] },
            { id: 18, name: 'ปูเปรี้ยวส้มตำ', category: 'rice', menu: [{ name: 'ส้มตำไทย', price: 35 }, { name: 'ไก่ย่าง', price: 40 }] },
            { id: 19, name: 'เบเกอรี่ ปังปัง', category: 'snack', menu: [{ name: 'แซนวิช', price: 25 }, { name: 'ขนมปังเนยสด', price: 20 }] },
            { id: 20, name: 'Juicy Delight', category: 'drink', menu: [{ name: 'น้ำผลไม้ปั่น', price: 30 }] },
            { id: 21, name: 'หมูทอดทงคัตสึไฮคิว', category: 'rice', menu: [{ name: 'ข้าวหน้าหมูทอดทงคัตสึ', price: 50 }] },
            { id: 22, name: 'ข้าวไข่เจียวบุฟเฟ่ต์', category: 'rice', menu: [{ name: 'ข้าวไข่เจียวทรงเครื่อง', price: 30 }] },
            { id: 23, name: 'กินข้าวแกง by พี่ก้อย', category: 'rice', menu: [{ name: 'ข้าวราดแกงปักษ์ใต้', price: 35 }] },
            { id: 24, name: 'อาหารนานาชาติ', category: 'rice', menu: [{ name: 'สปาเก็ตตี้', price: 45 }] },
            { id: 25, name: 'คอนร์ด็อก', category: 'snack', menu: [{ name: 'คอร์นด็อกชีส', price: 35 }] },
            { id: 26, name: 'กัสโมส ข้าวไก่อบ ไก่ราซอส', category: 'rice', menu: [{ name: 'ข้าวไก่อบ', price: 45 }, { name: 'ข้าวไก่ราซอส', price: 45 }] },
            { id: 27, name: 'ลูกชิ้นอร่อยจัง', category: 'snack', menu: [{ name: 'ลูกชิ้นปิ้ง', price: 10 }, { name: 'ลูกชิ้นทอด', price: 10 }] },
            { id: 28, name: 'ธนะสิทธ์ โจ๊ก ข้าวต้ม ต้มเลือดหมู', category: 'rice', menu: [{ name: 'โจ๊กหมู', price: 35 }, { name: 'ต้มเลือดหมู', price: 40 }] },
            { id: 29, name: 'อุษา ข้าวขาหมู ข้าวหมูแดง', category: 'rice', menu: [{ name: 'ข้าวขาหมู', price: 50 }, { name: 'ข้าวหมูแดงหมูกรอบ', price: 50 }] },
            { id: 30, name: 'นิจวิภา ไอศกรีม', category: 'snack', menu: [{ name: 'ไอศกรีมกะทิ', price: 20 }] },
            { id: 31, name: 'ฟุตบอลไข่ข้น', category: 'rice', menu: [{ name: 'ข้าวไข่ข้น', price: 40 }] },
            { id: 32, name: 'ไก่ย่างห้าดาว', category: 'snack', menu: [{ name: 'ไก่ย่าง', price: 25 }, { name: 'ไก่จ๊อ', price: 25 }] }
        ];

        const IMG_URLS = {
            drink: 'https://images.unsplash.com/photo-1543253687-c931c8e01820?auto=format&fit=crop&q=80&w=300',
            noodle: 'https://images.unsplash.com/photo-1552611052-33e04de081de?auto=format&fit=crop&q=80&w=300',
            rice: 'https://images.unsplash.com/photo-1512058564366-18510be2db19?auto=format&fit=crop&q=80&w=300',
            fruit: 'https://images.unsplash.com/photo-1502741224143-90386d7f8c82?auto=format&fit=crop&q=80&w=300',
            snack: 'https://images.unsplash.com/photo-1565557623262-b51c2513a641?auto=format&fit=crop&q=80&w=300'
        };

        const statusCfg = {
            new: { label: 'ออเดอร์ใหม่', bg: 'bg-red-50', border: 'border-red-200', dot: 'bg-red-500', text: 'text-red-700' },
            cooking: { label: 'กำลังทำ', bg: 'bg-amber-50', border: 'border-amber-200', dot: 'bg-amber-500', text: 'text-amber-700' },
            ready: { label: 'พร้อมเสิร์ฟ', bg: 'bg-green-50', border: 'border-green-200', dot: 'bg-green-500', text: 'text-green-700' },
            completed: { label: 'เสร็จสิ้น', bg: 'bg-gray-50', border: 'border-gray-200', dot: 'bg-gray-400', text: 'text-gray-500' },
        };

        const Btn = ({ cls, onClick, children }) => <button onClick={onClick} className={`py-2.5 rounded-xl text-sm font-semibold flex items-center justify-center gap-1 transition-all active:scale-[0.97] ${cls}`}>{children}</button>;

        const Modal = ({ title, onClose, children }) => (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[999] p-4" onClick={e => { if (e.target === e.currentTarget) onClose() }}>
                <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl slide-up relative">
                    <button onClick={onClose} className="absolute top-3 right-3 w-8 h-8 flex items-center justify-center rounded-full bg-red-100 hover:bg-red-200 transition-colors"><X size={18} className="text-red-500" /></button>
                    <h3 className="text-lg font-bold text-gray-800 mb-4">{title}</h3>
                    {children}
                </div>
            </div>
        );

        const StatCard = ({ icon: Icon, label, value, color, sub }) => (
            <div className="stat-card bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                <div className="flex items-center gap-3 mb-2">
                    <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${color}`}><Icon size={20} className="text-white" /></div>
                    <span className="text-xs text-gray-500 font-medium">{label}</span>
                </div>
                <p className="text-2xl font-bold text-gray-800">{value}</p>
                {sub && <p className="text-xs text-gray-400 mt-1">{sub}</p>}
            </div>
        );

        const OrderCard = ({ order, onAction }) => {
            const s = statusCfg[order.status];
            const actionBtn = {
                new: <><Btn cls="flex-1 bg-gradient-to-r from-amber-500 to-amber-600 text-white hover:shadow-md" onClick={() => onAction(order.id, 'cooking')}><ChefHat size={16} />รับออเดอร์</Btn><Btn cls="px-4 bg-white border border-red-200 text-red-500 hover:bg-red-50" onClick={() => onAction(order.id, 'cancelled')}><XCircle size={16} /></Btn></>,
                cooking: <Btn cls="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white hover:shadow-md" onClick={() => onAction(order.id, 'ready')}><CheckCircle size={16} />ทำเสร็จแล้ว</Btn>,
                ready: <Btn cls="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:shadow-md" onClick={() => onAction(order.id, 'completed')}><Package size={16} />ส่งมอบแล้ว</Btn>,
                completed: <div className="flex-1 py-2.5 rounded-xl bg-gray-100 text-gray-400 text-sm text-center font-medium">เสร็จสมบูรณ์ ✓</div>,
            };
            return (
                <div className={`${s.bg} border ${s.border} rounded-2xl p-4 fade-in`}>
                    <div className="flex justify-between items-start mb-3">
                        <div>
                            <div className="flex items-center gap-2">
                                <span className="font-bold text-lg text-gray-800">{order.id}</span>
                                <span className={`px-2 py-0.5 rounded-full text-[10px] font-semibold ${s.text} ${s.bg} border ${s.border} flex items-center gap-1`}><span className={`w-1.5 h-1.5 rounded-full ${s.dot} ${order.status === 'new' ? 'pulse-dot' : ''}`} />{s.label}</span>
                            </div>
                            <p className="text-sm text-gray-600 mt-0.5">{order.studentName}</p>
                        </div>
                        <div className="text-right">
                            <p className="text-xs text-gray-400 flex items-center gap-1"><Clock size={10} />{order.time}</p>
                            <p className="font-bold text-[#5D4037] text-lg">฿{order.total}</p>
                        </div>
                    </div>
                    <div className="bg-white/70 rounded-xl p-3 mb-3">
                        {order.items.map((it, i) => <div key={i} className="flex justify-between text-sm py-1"><span className="text-gray-700">{it.qty}x {it.name}</span><span className="text-gray-500">฿{it.price * it.qty}</span></div>)}
                        {order.note && <div className="mt-2 pt-2 border-t border-dashed border-gray-200 text-xs text-amber-700 flex items-start gap-1"><AlertCircle size={12} className="mt-0.5 flex-shrink-0" />{order.note}</div>}
                    </div>
                    <div className="flex gap-2">{actionBtn[order.status]}</div>
                </div>
            );
        };

        function App() {
            const [loggedIn, setLoggedIn] = useState(false);
            const [shopInfo, setShopInfo] = useState(null);
            const [tab, setTab] = useState('dashboard');
            const [orders, setOrders] = useState([]);
            const [menu, setMenu] = useState([]);
            const [orderFilter, setOrderFilter] = useState('all');
            const [modal, setModal] = useState(null); // {mode:'add'|'edit', item:{...}}

            useEffect(() => {
                if (!loggedIn || !shopInfo) return;

                const syncOrders = () => {
                    const allOrders = JSON.parse(localStorage.getItem('horwang_orders') || '[]');
                    const myOrders = allOrders.filter(o => o.shopId === shopInfo.id);

                    setOrders(prev => {
                        // Merge logic: keep local status changes, but add new orders from storage
                        const existingIds = prev.map(o => o.id);
                        const newOnes = myOrders.filter(o => !existingIds.includes(o.id));
                        return [...prev, ...newOnes];
                    });
                };

                // Initial sync
                syncOrders();

                // Listen for changes from other tabs
                const handleStorage = (e) => {
                    if (e.key === 'horwang_orders') syncOrders();
                };

                window.addEventListener('storage', handleStorage);
                return () => window.removeEventListener('storage', handleStorage);
            }, [loggedIn, shopInfo]);

            const shopName = shopInfo ? shopInfo.name : 'ร้านค้า';
            const shopCode = shopInfo ? `S-${String(shopInfo.id).padStart(3, '0')}` : '';
            const shopZone = shopInfo ? (shopInfo.id <= 11 ? 'โซน A' : shopInfo.id <= 22 ? 'โซน B' : 'โซน C') : '';

            const byStatus = s => orders.filter(o => o.status === s);
            const completed = byStatus('completed');
            const newCount = byStatus('new').length;
            const cookCount = byStatus('cooking').length;
            const revenue = completed.reduce((s, o) => s + o.total, 0);
            const totalSold = completed.reduce((s, o) => s + o.items.reduce((a, i) => a + i.qty, 0), 0);
            const filtered = orderFilter === 'all' ? orders.filter(o => o.status !== 'completed') : byStatus(orderFilter);

            const handleLogin = (id) => {
                const shop = SHOPS_DATA.find(s => s.id === id);
                if (shop) {
                    setShopInfo(shop);
                    const initialMenu = shop.menu.map((m, i) => ({
                        ...m,
                        id: i + 1,
                        image: IMG_URLS[shop.category] || IMG_URLS.rice,
                        available: true,
                        sold: Math.floor(Math.random() * 50) + 10
                    }));
                    setMenu(initialMenu);
                    setOrders([]); // Clear orders, useEffect will fetch from localStorage
                    setLoggedIn(true);
                }
            };

            const doOrder = (id, st) => {
                if (st === 'cancelled') {
                    setOrders(p => p.filter(o => o.id !== id));
                    // Also remove from localStorage to keep it clean
                    const allOrders = JSON.parse(localStorage.getItem('horwang_orders') || '[]');
                    localStorage.setItem('horwang_orders', JSON.stringify(allOrders.filter(o => o.id !== id)));
                    return;
                }
                setOrders(p => p.map(o => o.id === id ? { ...o, status: st } : o));
            };

            const saveMenu = () => {
                if (!modal) return;
                const { mode, item } = modal;
                if (!item.name || !item.price) return alert('กรุณากรอกข้อมูลให้ครบ');
                if (mode === 'add') setMenu(p => [...p, { ...item, id: Date.now(), image: IMG_URLS[shopInfo.category], available: true, sold: 0 }]);
                else setMenu(p => p.map(m => m.id === item.id ? item : m));
                setModal(null);
            };

            // Login
            if (!loggedIn) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-[#3E2723] via-[#5D4037] to-[#4E342E] flex flex-col items-center justify-center p-6 relative overflow-hidden">
                        <div className="absolute top-20 left-10 w-72 h-72 bg-amber-500/10 rounded-full blur-3xl" />
                        <div className="absolute bottom-20 right-10 w-96 h-96 bg-amber-600/[.08] rounded-full blur-3xl" />
                        <div className="glass p-10 rounded-3xl w-full max-w-sm shadow-2xl relative z-10 slide-up">
                            <div className="flex justify-center mb-4"><div className="w-16 h-16 bg-gradient-to-br from-amber-400 to-amber-600 rounded-2xl flex items-center justify-center shadow-lg shadow-amber-500/30"><Store size={32} className="text-white" /></div></div>
                            <h1 className="text-2xl font-bold text-white text-center mb-1">ระบบร้านค้า</h1>
                            <p className="text-amber-200/70 text-center mb-8 text-sm">Digital Canteen — Shop Panel</p>
                            <LoginForm onLogin={handleLogin} />
                        </div>
                        <p className="absolute bottom-6 text-white/30 text-xs">© 2026 Digital Canteen • Developed by Antigravity</p>
                    </div>
                );
            }

            return (
                <div className="bg-gray-50 min-h-screen pb-24 max-w-lg mx-auto relative shadow-2xl">
                    <header className="bg-gradient-to-r from-[#4E342E] to-[#5D4037] text-white p-4 sticky top-0 z-20 shadow-lg rounded-b-2xl">
                        <div className="flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="w-11 h-11 bg-gradient-to-br from-amber-400 to-amber-600 rounded-xl flex items-center justify-center shadow-md"><Store size={22} className="text-white" /></div>
                                <div><h2 className="font-bold text-base leading-tight">{shopName}</h2><p className="text-amber-300/80 text-xs">{shopCode} • {shopZone}</p></div>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className="relative cursor-pointer" onClick={() => setTab('orders')}><Bell size={22} />{newCount > 0 && <span className="absolute -top-1 -right-1 bg-red-500 text-[10px] w-4 h-4 flex items-center justify-center rounded-full font-bold border-2 border-[#5D4037] pulse-dot">{newCount}</span>}</div>
                                <button onClick={() => setLoggedIn(false)} className="p-2 rounded-lg hover:bg-white/10 transition-colors"><LogOut size={20} /></button>
                            </div>
                        </div>
                    </header>

                    <main className="p-4">
                        {tab === 'dashboard' && (
                            <div className="fade-in space-y-5">
                                <div>
                                    <h3 className="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2"><BarChart3 size={20} className="text-[#5D4037]" />สรุปวันนี้</h3>
                                    <div className="grid grid-cols-2 gap-3">
                                        <StatCard icon={DollarSign} label="รายได้วันนี้" value={`฿${revenue}`} color="bg-gradient-to-br from-green-400 to-emerald-600" sub={`${completed.length} ออเดอร์สำเร็จ`} />
                                        <StatCard icon={ShoppingBag} label="ขายได้" value={`${totalSold} จาน`} color="bg-gradient-to-br from-blue-400 to-blue-600" sub="อัพเดทอัตโนมัติ" />
                                        <StatCard icon={ClipboardList} label="รอดำเนินการ" value={newCount + cookCount} color="bg-gradient-to-br from-amber-400 to-orange-500" sub={`${newCount} ใหม่ • ${cookCount} กำลังทำ`} />
                                        <StatCard icon={Utensils} label="เมนูเปิดขาย" value={`${menu.filter(m => m.available).length}/${menu.length}`} color="bg-gradient-to-br from-purple-400 to-purple-600" sub="เมนูที่พร้อมขาย" />
                                    </div>
                                </div>
                                <div>
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2"><Bell size={20} className="text-red-500" />ออเดอร์ใหม่ {newCount > 0 && <span className="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">{newCount}</span>}</h3>
                                        {newCount > 0 && <button onClick={() => { setTab('orders'); setOrderFilter('new'); }} className="text-sm text-[#5D4037] font-medium hover:underline">ดูทั้งหมด</button>}
                                    </div>
                                    {newCount > 0 ? (
                                        <div className="space-y-3">{byStatus('new').slice(0, 2).map(o => <OrderCard key={o.id} order={o} onAction={doOrder} />)}</div>
                                    ) : (
                                        <div className="bg-white rounded-xl p-6 text-center text-gray-400 text-sm border border-dashed border-gray-200">ไม่มีออเดอร์</div>
                                    )}
                                </div>
                            </div>
                        )}

                        {tab === 'orders' && (
                            <div className="fade-in space-y-4">
                                <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2"><ClipboardList size={20} className="text-[#5D4037]" />จัดการออเดอร์</h3>
                                <div className="flex gap-2 overflow-x-auto scrollbar-hide pb-1">
                                    {[['all', 'ทั้งหมด'], ['new', `ใหม่ (${newCount})`], ['cooking', `กำลังทำ (${cookCount})`], ['ready', `พร้อมเสิร์ฟ (${byStatus('ready').length})`], ['completed', 'เสร็จสิ้น']].map(([k, l]) => (
                                        <button key={k} onClick={() => setOrderFilter(k)} className={`flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-colors whitespace-nowrap ${orderFilter === k ? 'bg-[#5D4037] text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200'}`}>{l}</button>
                                    ))}
                                </div>
                                <div className="space-y-3">
                                    {filtered.length === 0 ? <div className="text-center py-16 text-gray-400"><CheckCircle size={40} className="mx-auto mb-3 text-gray-300" /><p className="font-medium">ไม่มีออเดอร์ในหมวดนี้</p></div>
                                        : filtered.map(o => <OrderCard key={o.id} order={o} onAction={doOrder} />)}
                                </div>
                            </div>
                        )}

                        {tab === 'menu' && (
                            <div className="fade-in space-y-4">
                                <div className="flex justify-between items-center">
                                    <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2"><Utensils size={20} className="text-[#5D4037]" />จัดการเมนู</h3>
                                    <button onClick={() => setModal({ mode: 'add', item: { name: '', price: '' } })} className="px-4 py-2 rounded-xl bg-gradient-to-r from-amber-500 to-amber-600 text-white text-sm font-semibold flex items-center gap-1 hover:shadow-md active:scale-[0.97]"><Plus size={16} />เพิ่มเมนู</button>
                                </div>

                                <div className="space-y-3">
                                    {menu.map(item => (
                                        <div key={item.id} className={`bg-white rounded-2xl p-4 shadow-sm border ${item.available ? 'border-gray-100' : 'border-red-100 opacity-70'} transition-all`}>
                                            <div className="flex gap-3">
                                                <img src={item.image} className="w-20 h-20 rounded-xl object-cover bg-gray-100" alt="" />
                                                <div className="flex-1">
                                                    <div className="flex justify-between items-start">
                                                        <div><h4 className="font-bold text-gray-800">{item.name}</h4><p className="text-[#5D4037] font-bold text-lg">฿{item.price}</p></div>
                                                        <span className={`px-2 py-0.5 rounded-full text-[10px] font-semibold ${item.available ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-600'}`}>{item.available ? 'เปิดขาย' : 'ปิดขาย'}</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 mt-2">
                                                        <button onClick={() => setMenu(p => p.map(m => m.id === item.id ? { ...m, available: !m.available } : m))} className={`px-3 py-1.5 rounded-lg text-xs font-medium flex items-center gap-1 ${item.available ? 'bg-red-50 text-red-600 hover:bg-red-100' : 'bg-green-50 text-green-600 hover:bg-green-100'}`}>{item.available ? <><EyeOff size={12} />ปิดขาย</> : <><Eye size={12} />เปิดขาย</>}</button>
                                                        <button onClick={() => setModal({ mode: 'edit', item: { ...item } })} className="px-3 py-1.5 rounded-lg text-xs font-medium bg-blue-50 text-blue-600 hover:bg-blue-100 flex items-center gap-1"><Edit3 size={12} />แก้ไข</button>
                                                        <button onClick={() => confirm('ลบเมนูนี้?') && setMenu(p => p.filter(m => m.id !== item.id))} className="px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-50 text-gray-500 hover:bg-gray-100 flex items-center gap-1"><Trash2 size={12} />ลบ</button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="mt-2 pt-2 border-t border-gray-50 flex justify-between text-xs text-gray-400"><span>ขายไปแล้ว {item.sold} จาน</span><span>รายได้ ฿{item.sold * item.price}</span></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {tab === 'sales' && (
                            <div className="fade-in space-y-5">
                                <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2"><TrendingUp size={20} className="text-[#5D4037]" />สรุปยอดขาย</h3>
                                <div className="bg-gradient-to-br from-[#5D4037] to-[#3E2723] rounded-2xl p-5 text-white shadow-lg">
                                    <p className="text-amber-200/70 text-sm mb-1">รายได้ทั้งหมดวันนี้</p>
                                    <p className="text-4xl font-bold">฿{revenue}</p>
                                    <div className="flex gap-4 mt-4">
                                        {[['ออเดอร์สำเร็จ', completed.length], ['จานทั้งหมด', totalSold], ['เฉลี่ย/ออเดอร์', `฿${completed.length > 0 ? Math.round(revenue / completed.length) : 0}`]].map(([l, v], i) => (
                                            <div key={i} className="bg-white/10 rounded-xl px-4 py-2 flex-1 text-center"><p className="text-amber-200 text-xs">{l}</p><p className="text-xl font-bold">{v}</p></div>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <h4 className="font-bold text-gray-700 mb-3">ออเดอร์ที่เสร็จสิ้น</h4>
                                    <div className="space-y-2">
                                        {completed.length === 0 ? <div className="text-center py-12 text-gray-400"><CheckCircle size={36} className="mx-auto mb-2 text-gray-300" /><p>ยังไม่มีออเดอร์ที่เสร็จสิ้น</p></div>
                                            : completed.map(o => (
                                                <div key={o.id} className="bg-white rounded-xl p-3 shadow-sm flex justify-between items-center border border-gray-100">
                                                    <div className="flex items-center gap-3"><div className="w-9 h-9 bg-green-100 rounded-lg flex items-center justify-center"><CheckCircle size={18} className="text-green-600" /></div><div><p className="font-semibold text-sm text-gray-800">{o.id}</p><p className="text-xs text-gray-400">{o.studentName} • {o.time}</p></div></div>
                                                    <span className="font-bold text-[#5D4037]">฿{o.total}</span>
                                                </div>
                                            ))}
                                    </div>
                                </div>
                                <div>
                                    <h4 className="font-bold text-gray-700 mb-3">รายได้ตามเมนู</h4>
                                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                                        {menu.map((it, i) => {
                                            const rev = it.sold * it.price, max = Math.max(...menu.map(m => m.sold * m.price)); return (
                                                <div key={it.id} className={`p-3 ${i > 0 ? 'border-t border-gray-50' : ''}`}>
                                                    <div className="flex justify-between items-center mb-1"><span className="text-sm font-medium text-gray-700">{it.name}</span><span className="text-sm font-bold text-[#5D4037]">฿{rev}</span></div>
                                                    <div className="w-full bg-gray-100 rounded-full h-2"><div className="bg-gradient-to-r from-amber-400 to-amber-600 h-2 rounded-full" style={{ width: `${max > 0 ? (rev / max * 100) : 0}%` }} /></div>
                                                    <p className="text-[10px] text-gray-400 mt-1">{it.sold} จาน × ฿{it.price}</p>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                    {modal && <Modal title={modal.mode === 'add' ? 'เพิ่มเมนูใหม่' : 'แก้ไขเมนู'} onClose={() => setModal(null)}>
                        <div className="space-y-3">
                            <input type="text" placeholder="ชื่อเมนู" className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-400 text-sm" value={modal.item.name} onChange={e => setModal({ ...modal, item: { ...modal.item, name: e.target.value } })} />
                            <input type="number" placeholder="ราคา (บาท)" className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-400 text-sm" value={modal.item.price} onChange={e => setModal({ ...modal, item: { ...modal.item, price: parseInt(e.target.value) || '' } })} />
                            <button onClick={saveMenu} className="w-full py-3 rounded-xl bg-gradient-to-r from-amber-500 to-amber-600 text-white font-semibold hover:shadow-md active:scale-[0.98] flex items-center justify-center gap-2"><Save size={18} />บันทึก</button>
                        </div>
                    </Modal>}

                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 py-2 px-4 flex justify-around items-center z-30 max-w-lg mx-auto text-xs font-medium text-gray-400">
                        {[['dashboard', Home, 'หน้าหลัก', 0], ['orders', ClipboardList, 'ออเดอร์', newCount], ['menu', Utensils, 'เมนู', 0], ['sales', BarChart3, 'ยอดขาย', 0]].map(([k, Icon, label, badge]) => (
                            <button key={k} onClick={() => setTab(k)} className={`flex flex-col items-center gap-1 transition-colors ${tab === k ? 'text-[#5D4037]' : 'hover:text-gray-600'}`}>
                                <div className="relative"><Icon size={24} strokeWidth={tab === k ? 2.5 : 2} />{badge > 0 && <span className="absolute -top-1 -right-1.5 bg-red-500 text-white text-[9px] w-4 h-4 flex items-center justify-center rounded-full font-bold border-2 border-white pulse-dot">{badge}</span>}</div>
                                {label}
                            </button>
                        ))}
                    </nav>
                </div>
            );
        }

        function LoginForm({ onLogin }) {
            const [v, setV] = useState('');
            const submit = () => { const n = parseInt(v); n >= 1 && n <= 32 ? onLogin(n) : alert('กรุณากรอกเลขร้านค้า 1-32') };
            return <div className="space-y-4">
                <div className="relative"><Hash className="absolute left-4 top-3.5 text-gray-400 w-5 h-5" /><input type="number" min="1" max="32" placeholder="เลขร้านค้า (1-32)" className="w-full pl-12 pr-4 py-3.5 rounded-xl bg-white/90 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-amber-400 font-medium" value={v} onChange={e => setV(e.target.value)} onKeyDown={e => e.key === 'Enter' && submit()} /></div>
                <button onClick={submit} className="w-full py-3.5 rounded-xl bg-gradient-to-r from-amber-500 to-amber-600 text-white font-semibold hover:from-amber-600 hover:to-amber-700 active:scale-[0.98] shadow-lg shadow-amber-500/30 flex items-center justify-center gap-2">เข้าสู่ระบบ <ChevronRight size={20} /></button>
            </div>;
        }

        try {
            ReactDOM.createRoot(document.getElementById('root')).render(<App />);
        } catch (err) {
            console.error('Render error:', err);
            document.getElementById('error-display').style.display = 'block';
            document.getElementById('error-message').innerText = err.message;
        }

        window.onerror = function (msg, url, line, col, error) {
            document.getElementById('error-display').style.display = 'block';
            document.getElementById('error-message').innerText = msg + ' (line ' + line + ')';
            return false;
        };
    </script>
</body>

</html>